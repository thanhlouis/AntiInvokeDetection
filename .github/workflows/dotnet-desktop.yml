name: Build AntiInvokeDetection .NET Framework

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: windows-2022 
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      # BƯỚC MỚI: Tải và Cài đặt .NET Framework 4.5 Developer Pack bằng PowerShell
      - name: Install .NET Framework 4.5 Targeting Pack Manually
        run: |
          # Đường dẫn tải xuống chính thức cho .NET Framework 4.5 Developer Pack
          $url = "https://download.visualstudio.microsoft.com/download/pr/10903322/2a138980af463765181e19bc5a4b1ff3/NDP45-DevPack-KB2765955-ENU.exe"
          $fileName = "NDP45-DevPack.exe"
          
          # Tải file cài đặt
          Write-Host "Downloading .NET Framework 4.5 Developer Pack..."
          Invoke-WebRequest -Uri $url -OutFile $fileName
          
          # Chạy cài đặt im lặng (/q)
          Write-Host "Installing .NET Framework 4.5 Developer Pack..."
          & ".\$fileName" /q /norestart
          
          # Dọn dẹp
          Remove-Item $fileName
        shell: powershell # Đảm bảo dùng PowerShell
        
      # --- CẤU HÌNH CÔNG CỤ (Giữ nguyên) ---
      
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1 
        
      - name: Setup NuGet CLI
        uses: nuget/setup-nuget@v1
        
      # --- BUILD VÀ ĐÓNG GÓI ---
      
      - name: Restore NuGet Packages
        run: nuget restore "Anti Invoke Detection.sln"

      - name: Build Solution (Release)
        run: msbuild "Anti Invoke Detection.sln" /p:Configuration=Release

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: AntiInvokeDetection-exe
          path: Anti Invoke Detection/bin/Release/Anti Invoke Detection.exe
